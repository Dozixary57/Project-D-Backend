//Timer
//setTimeout(() => {
//    fastify.close(() => {
//        console.log('Server stopped');
//    });
//}, 600000);


//// Declare a route
//fastify.get('/Item/:id', async function (req, reply) {
//    try {
//        const id = new this.mongo.ObjectId(req.params.id)
//        const item = await fastify.mongo.db.collection('items').findOne({ _id: id })
//        reply.status(200).send(item)
//    } catch (err) {
//        reply.send(err)
//    }
//})


//reply.header('Cache-Control', 'public, max-age=30');


//fastify.get('/Item/:id', async function (req, reply) {
    //    // http://localhost:5000/Item/64825519e97f28274a958dca
    //    try {
    //        if (mongodb.ObjectId.isValid(req.params.id)) {
    //            const id = new this.mongo.ObjectId(req.params.id)
    //            const item = await fastify.mongo.db.collection('items2').findOne({ _id: id })
    //            if (item) {
    //                //reply.redirect(301, `/Item/${item.itemTitle}`).send(item)
    //                reply.status(200).send(item)
    //                return
    //            }
    //        } else {
    //            const Title_ = req.params.id
    //            const Title = Title_.replace(/_/g, ' ')
    //            const item = await fastify.mongo.db.collection('items2').findOne({ itemTitle: Title })
    //            reply.send(Title_)
    //            //if (item) {
    //            //    //reply.redirect(301, `/Item/${item.itemTitle}`).send(item)
    //            //    console.log(chalk.red('Found!'))
    //            //    reply.status(200).send(item)
    //            //    return
    //            //} else {
    //            //    console.log('Not found!')
    //            //    reply.status(404).send('Item not found.')
    //            //    return
    //            //}
    //        }
    //    } catch (err) {
    //        reply.send(err);
    //    }
    //})

//�� ������ ����� ����� ������� (�� �������, ���� �����_��� � URL) ���!!! �� ���� ������(((
 fastify.get('/Item/:id', async function (req, reply) {
        // http://localhost:5000/Item/64825519e97f28274a958dca
        try {
            if (mongodb.ObjectId.isValid(req.params.id)) {
                const id = new this.mongo.ObjectId(req.params.id)
                const item = await fastify.mongo.db.collection('items2').findOne({ _id: id })
                if (item) {
                    //reply.redirect(301, `/Item/${item.itemTitle}`).send(item)
                    reply.status(200).send(item)
                    return
                }
            } else {
                const Title_ = req.params.id
                const Title = Title_.replace(/_/g, ' ')
                const item = await fastify.mongo.db.collection('items2').findOne({ itemTitle: Title })
                reply.send(Title_)
                //if (item) {
                //    //reply.redirect(301, `/Item/${item.itemTitle}`).send(item)
                //    console.log(chalk.red('Found!'))
                //    reply.status(200).send(item)
                //    return
                //} else {
                //    console.log('Not found!')
                //    reply.status(404).send('Item not found.')
                //    return
                //}
            }
        } catch (err) {
            reply.send(err);
        }
    })
}

            //const id = new this.mongo.ObjectId(req.params.id)
            //const file = await this.mongo.db.collection('fs.files').findOne({ _id: id })

            //if (!file) {
            //    reply.status(404).send('File not found!')
            //    return
            //} else {
            //    reply.status(200).send(file.filename)
            //    return
            //}
            
            
            
            
            /*            if (fs.existsSync(path.join('GridFS', 'Covers', `Branch.png`))) {
                            console.log('Файл существует');
                        } else {
                            console.log('Файл не существует');
                        }*/
                        
                        // const id = new this.mongo.ObjectId(req.params.id)
                        
                        // reply.send(path.join(process.cwd(), 'GridFS', 'Covers', `${id}`));
            
            /*            const db = this.mongo.db;
                        const bucket = new mongodb.GridFSBucket(db, { bucketName: 'fs' });
                        const fileCursor = bucket.find({ _id: id });
            
                        if (await fileCursor.hasNext()) {
                            const filename = (await fileCursor.next()).filename;
                            const imagePath = path.join(process.cwd(), 'GridFS', 'Covers', `${filename}`);
                            reply.send(imagePath);
                        } else {
                            reply.code(404).send({ error: 'Image not found' });
                        }*/






                            // Items Collection Data Updater
                            const ItemsDataChangeStream = fastify.mongo.db.collection('Items').watch()
                            ItemsDataChangeStream.on('change', () => {
                                Logger.DB('Change detected.');
                                // WebSocketEvent
                        /*        fastify.websocket.on('connection', (socket, request) => {
                                    socket.send(JSON.stringify({message: 'Hello from server'}));

                        /!*            socket.on('message', message => {
                                        // Обработка сообщения от клиента
                                    });*!/

                                })*/
                            })



const Logger = require("../Tools/Logger");
const Mercurius = require('mercurius');
const mongodb = require("mongodb");
const fs = require("fs");
const path = require("path");

let paramsId;

module.exports = async function (fastify) {
    const collection = fastify.config.COLLECTION_ITEMS
    const server = fastify.config.SERVER


    const schema = `
      type Items {
        _id: String
        Title: String
        IconURL: String
      }

      type Item {
        _id: String
        Title: String
        Description: String
        CoverURL: String
      }

      type Query {
        ItemsQuery: [Items]
        ItemQuery: Item
      }
    `;

    const resolvers = {
        Query: {
            ItemsQuery: async () => {
                const items = await fastify.mongo.db.collection(collection).find().toArray()

                const result = await Promise.all(items.map(document => ({
                    _id: document._id,
                    Title: document.Title,
                    IconURL: `${server}/Icon/${document.Title}`,
                })));
                return result;
            },
            ItemQuery: async (obj, args, context) => {

                const item = await fastify.mongo.db.collection(collection).findOne({ Title: paramsId.replace(/_/g, ' ') });

                return {
                    _id: item._id,
                    Title: item.Title,
                    Description: item.Description,
                    CoverURL: item.Media.CoverURL,
                };
            },
        },
    };


    fastify.register(Mercurius, {
        schema,
        resolvers,
        graphiql: false,
    }).ready(()=> {
        Logger.Server.Ok('@Fastify/Mercurius успешно зарегестрирован!')
    });

    // Declare a route
    fastify.get('/Items', async function (req, reply) {
        try {
            const result = await fastify.graphql(`query { ItemsQuery { _id, Title, IconURL } }`);
            reply.status(200).send(result.data.ItemsQuery)
        } catch (err) {
            reply.send(err)
        }
    })

    fastify.register(async function (fastify) {
        fastify.get('/Items-WS', { websocket: true }, (connection /* SocketStream */, req /* FastifyRequest */) => {
            connection.socket.on('message', async (message) => {
                console.log(message.toString())
                connection.socket.send('hi from server')
            })
        })
    })

    fastify.get('/Item/:id', async function (req, reply) {
        try {
            paramsId = req.params.id
            const result = await fastify.graphql(`query { ItemQuery { _id, Title, Description, CoverURL } }`);
            paramsId = null
            reply.status(200).send(result.data.ItemQuery)
            /*            let item = await fastify.mongo.db.collection(collection).findOne({ Title: req.params.id.replace(/_/g, ' ') })
                        if (item) {
                            reply.status(200).send(item)
                            return
                        } else {
                            const id = new this.mongo.ObjectId(req.params.id)
                            item = await fastify.mongo.db.collection(collection).findOne({ _id: id })
                            if (item) {
                                reply.redirect(302, `/Item/${item.Title.replace(/ /g, '_')}`).send(item)
                                return
                            } else {
                                reply.status(404).send('Item not found.')
                                return
                            }
                        }*/
        } catch {
            reply.status(404).send('Item not found.')
        }
    })
}





